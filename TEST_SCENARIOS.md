# C2C MVP 테스트 시나리오 설계

## 📋 테스트 전략 개요

### 테스트 피라미드
1. **단위 테스트 (70%)**: 도메인 로직, 서비스, 리포지토리
2. **통합 테스트 (20%)**: WebSocket, Redis, PostgreSQL 연동
3. **E2E 테스트 (10%)**: 전체 사용자 플로우

### 핵심 비즈니스 룰 검증 
- ✅ **5분 TTL**: 빈 방 5분 후 삭제
- ✅ **30초 프레즌스**: 하트비트 타임아웃
- ✅ **Rate Limiting**: 초당 5회 메시지 제한
- ✅ **메시지 크기**: 2KB 제한
- ✅ **비영속**: 메시지 DB 저장 안 함

## 🔍 상세 테스트 시나리오

### 1. 도메인 단위 테스트

#### 1.1 Room 도메인 테스트
```
✓ Room 생성 시 초기 상태 검증
✓ 멤버 추가/제거 기능
✓ 빈 방 감지 로직
✓ TTL 계산 정확성
✓ 최대 멤버 수 제한 (10명)
```

#### 1.2 User 도메인 테스트
```
✓ User 생성 및 프레즌스 초기화
✓ 하트비트 업데이트 로직
✓ 30초 타임아웃 감지
✓ 세션 ID 유효성
```

#### 1.3 Message 도메인 테스트
```
✓ Message 생성 및 검증
✓ 2KB 크기 제한 체크
✓ 빈 메시지 거부
✓ 특수문자 처리
```

#### 1.4 도메인 서비스 테스트
```
✓ RoomService: 방 생성/입장/퇴장/삭제
✓ MessageService: Rate limiting (초당 5회)
✓ UserService: 프레즌스 관리
```

### 2. 인프라스트럭처 통합 테스트

#### 2.1 Redis 연동 테스트
```
✓ RoomRedisRepository: Lua 스크립트 원자적 처리
✓ UserRedisRepository: 프레즌스 TTL 관리
✓ RedisMessageBroker: Pub/Sub 메시지 전송/수신
✓ Redis 연결 실패 시 복구
```

#### 2.2 PostgreSQL 연동 테스트
```
✓ ErrorInfoRepository: 에러 코드 조회
✓ JPA 엔티티 매핑 검증
✓ 데이터베이스 트랜잭션
✓ Connection Pool 관리
```

#### 2.3 WebSocket 통합 테스트
```
✓ 연결 설정 및 해제
✓ 메시지 송수신 프로토콜
✓ 하트비트 ping/pong
✓ 에러 메시지 전송
✓ 다중 클라이언트 연결
```

### 3. E2E 테스트 시나리오

#### 3.1 기본 채팅방 플로우
```
시나리오: 새 방 생성 및 대화
Given: 사용자 A가 메인 페이지에 접속
When: "새로운 방 만들기"를 선택하고 닉네임 입력
Then: 채팅방이 생성되고 WebSocket 연결됨
And: 초대 링크 복사 가능
And: 사용자 B가 초대 링크로 입장 가능
And: 실시간 메시지 송수신 가능
```

#### 3.2 방 TTL 및 정리 플로우
```
시나리오: 빈 방 5분 후 삭제
Given: 사용자 A만 있는 방
When: 사용자 A가 방을 나감
Then: "5분 후 방이 없어져요" 경고 표시
And: 5분 경과 후 방 자동 삭제
And: 재입장 시도 시 "방을 찾을 수 없음" 에러
```

#### 3.3 Rate Limiting 테스트
```
시나리오: 메시지 전송 제한
Given: 사용자가 채팅방에 입장
When: 초당 5회 이상 메시지 전송 시도
Then: "메시지 전송 제한 초과" 에러 표시
And: 1초 후 다시 전송 가능
```

#### 3.4 하트비트 및 프레즌스 테스트
```
시나리오: 연결 끊김 처리
Given: 사용자가 채팅방에 참여 중
When: 네트워크 연결이 30초 이상 끊어짐
Then: "연결이 끊어졌습니다" 상태 표시
And: 자동 재연결 시도
And: 다른 사용자에게 "퇴장" 알림 전송
```

### 4. 성능 및 부하 테스트

#### 4.1 동시 접속 테스트
```
✓ 동시 접속자 100명 처리
✓ 메모리 사용량 모니터링
✓ Redis 연결 풀 관리
✓ WebSocket 연결 안정성
```

#### 4.2 메시지 처리 성능
```
✓ 초당 1000개 메시지 처리
✓ Pub/Sub 지연시간 측정
✓ 메모리 누수 검증
```

### 5. 예외 상황 테스트

#### 5.1 시스템 장애 대응
```
✓ Redis 서버 다운 시 복구
✓ PostgreSQL 연결 실패 처리
✓ WebSocket 연결 실패 재시도
✓ 메모리 부족 상황 대응
```

#### 5.2 악성 입력 처리
```
✓ XSS 공격 시도 차단
✓ SQL Injection 방지
✓ 과도한 크기 메시지 거부
✓ 잘못된 JSON 형식 처리
```

## 📊 테스트 커버리지 목표

### 코드 커버리지
- **라인 커버리지**: 85% 이상
- **브랜치 커버리지**: 80% 이상
- **메서드 커버리지**: 90% 이상

### 기능 커버리지
- **핵심 비즈니스 룰**: 100%
- **API 엔드포인트**: 100%
- **WebSocket 프로토콜**: 100%
- **에러 시나리오**: 90%

## 🚀 테스트 실행 계획

### Phase 1: 단위 테스트
```bash
./gradlew test
./gradlew jacocoTestReport
```

### Phase 2: 통합 테스트
```bash
./gradlew integrationTest
docker-compose -f docker-compose.test.yml up -d
```

### Phase 3: E2E 테스트
```bash
./gradlew e2eTest
./scripts/start.sh start --test
```

### Phase 4: 성능 테스트
```bash
./gradlew performanceTest
./scripts/load-test.sh
```

## ✅ 성공 기준

### 품질 게이트
1. **모든 단위 테스트 통과** (0 실패)
2. **통합 테스트 95% 이상 통과**
3. **E2E 핵심 시나리오 100% 통과**
4. **성능 기준 달성** (응답시간 < 100ms)
5. **메모리 사용량** < 1GB (부하 테스트)

### 배포 가능 조건
- ✅ 모든 테스트 통과
- ✅ 코드 커버리지 목표 달성
- ✅ 성능 기준 만족
- ✅ 보안 취약점 없음
- ✅ Docker 컨테이너 정상 동작