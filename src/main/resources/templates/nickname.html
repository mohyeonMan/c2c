<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹‰ë„¤ì„ ì…ë ¥ - C2C</title>
    
    <!-- ë ˆì´ì•„ì›ƒ CSS í¬í•¨ -->
    <th:block th:include="~{layout :: head}"></th:block>
    
    <style>
        /* ë‹‰ë„¤ì„ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .nickname-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 24px;
            text-align: center;
        }
        
        .nickname-header {
            margin-bottom: 40px;
        }
        
        .nickname-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
        }
        
        .nickname-subtitle {
            font-size: var(--font-size-body);
            color: var(--color-text-secondary);
            line-height: 1.5;
        }
        
        /* ë°© ì •ë³´ (ì°¸ì—¬í•˜ê¸° ëª¨ë“œì¼ ë•Œ) */
        .room-info {
            background: var(--color-bg-soft);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 32px;
            text-align: left;
        }
        
        .room-info-label {
            font-size: var(--font-size-small);
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }
        
        .room-info-value {
            font-size: var(--font-size-body);
            font-weight: 600;
            color: var(--color-text);
            word-break: break-all;
        }
        
        /* í¼ ìŠ¤íƒ€ì¼ */
        .nickname-form {
            max-width: 320px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-size: var(--font-size-small);
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 8px;
        }
        
        .nickname-input {
            font-size: 18px;
            text-align: center;
            padding: 16px;
        }
        
        .char-counter {
            text-align: right;
            font-size: var(--font-size-small);
            color: var(--color-text-secondary);
            margin-top: 4px;
        }
        
        .char-counter.warning {
            color: var(--color-warning);
        }
        
        .char-counter.danger {
            color: var(--color-danger);
        }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: flex;
            gap: 12px;
        }
        
        .back-link {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: var(--font-size-small);
            margin-top: 20px;
            display: inline-block;
            transition: color 120ms ease-out;
        }
        
        .back-link:hover {
            color: var(--color-primary);
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ë°” -->
    <div class="loading-bar" id="loadingBar"></div>
    
    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="nickname-container">
            <!-- í—¤ë” -->
            <div class="nickname-header">
                <h1 class="nickname-title" th:text="${mode == 'create'} ? 'ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°' : (${mode == 'join'} ? 'ì±„íŒ…ë°© ì°¸ì—¬í•˜ê¸°' : 'ë‹‰ë„¤ì„ ì…ë ¥')">
                    ë‹‰ë„¤ì„ ì…ë ¥
                </h1>
                <p class="nickname-subtitle">
                    ëŒ€í™”ì—ì„œ ì–´ë–»ê²Œ ë¶ˆëŸ¬ë“œë¦´ê¹Œìš”?<br>
                    ì–¸ì œë“ ì§€ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.
                </p>
            </div>
            
            <!-- ë°© ì •ë³´ (ì°¸ì—¬í•˜ê¸° ëª¨ë“œ) -->
            <div class="room-info" th:if="${roomId}" style="text-align: left;">
                <div class="room-info-label">ì°¸ì—¬í•  ë°©</div>
                <div class="room-info-value" th:text="${roomId}">abc123</div>
            </div>
            
            <!-- ë‹‰ë„¤ì„ ì…ë ¥ í¼ -->
            <form class="nickname-form" onsubmit="submitForm(event)">
                <div class="form-group">
                    <label class="form-label" for="nickname">ë‹‰ë„¤ì„</label>
                    <input type="text" 
                           id="nickname" 
                           class="input nickname-input" 
                           placeholder="ì˜ˆ: ì»¤í”¼ì‚¬ë‘, ë°¤ì˜¬ë¹¼ë¯¸, ìƒˆì‹¹ì´"
                           maxlength="20"
                           oninput="updateCharCounter()"
                           required>
                    <div class="char-counter" id="charCounter">0 / 20</div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goBack()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitBtn"
                            th:text="${mode == 'create'} ? 'ë°© ë§Œë“¤ê³  ì…ì¥' : 'ë°© ì°¸ì—¬í•˜ê¸°'">
                        ë°© ì°¸ì—¬í•˜ê¸°
                    </button>
                </div>
            </form>
            
            <!-- ë’¤ë¡œê°€ê¸° ë§í¬ -->
            <a href="/" class="back-link">â† ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>
    
    <!-- C2C ê³µí†µ JavaScript ëª¨ë“ˆ ë¡œë“œ -->
    <script src="/js/c2c-common.js"></script>
    
    <script>
        // C2C ê³µí†µ ëª¨ë“ˆ ì‚¬ìš©
        
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
        const pageData = {
            mode: /*[[${mode}]]*/ 'join',
            roomId: /*[[${roomId}]]*/ null
        };
        
        // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
        function updateCharCounter() {
            const input = document.getElementById('nickname');
            const counter = document.getElementById('charCounter');
            const length = input.value.length;
            
            counter.textContent = `${length} / 20`;
            
            if (length > 18) {
                counter.classList.add('danger');
                counter.classList.remove('warning');
            } else if (length > 15) {
                counter.classList.add('warning');
                counter.classList.remove('danger');
            } else {
                counter.classList.remove('warning', 'danger');
            }
        }
        
        // í¼ ì œì¶œ ì²˜ë¦¬
        async function submitForm(event) {
            event.preventDefault();
            
            const nickname = document.getElementById('nickname').value;
            
            // ê³µí†µ ëª¨ë“ˆì˜ ê²€ì¦ ì‚¬ìš©
            const validation = C2C.validation.validateNickname(nickname);
            if (!validation.valid) {
                C2C.ui.showToast(validation.message, 'warning');
                document.getElementById('nickname').focus();
                return;
            }
            
            C2C.ui.showLoading();
            
            // ëª¨ë“œì— ë”°ë¥¸ ì²˜ë¦¬
            if (pageData.mode === 'create') {
                await createRoomAndJoin(validation.value);
            } else if (pageData.mode === 'join' && pageData.roomId) {
                await joinExistingRoom(pageData.roomId, validation.value);
            } else {
                C2C.ui.showToast('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤', 'danger');
                C2C.ui.hideLoading();
            }
        }
        
        // ë°© ìƒì„± ë° ì…ì¥
        async function createRoomAndJoin(nickname) {
            try {
                const result = await C2C.api.createRoom(nickname);
                
                if (result.success) {
                    console.log('âœ… ë°© ìƒì„± ì„±ê³µ:', result);
                    // ìƒì„±ëœ ë°©ìœ¼ë¡œ ì§ì ‘ ì´ë™ (ìƒˆë¡œê³ ì¹¨ ì•ˆì „)
                    window.location.href = `/chat/${result.data.roomId}?nickname=${encodeURIComponent(nickname)}`;
                } else {
                    console.error('âŒ ë°© ìƒì„± ì‹¤íŒ¨:', result.error);
                    C2C.ui.showToast(result.error || 'ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'danger');
                    C2C.ui.hideLoading();
                }
            } catch (error) {
                console.error('ğŸ’¥ ë°© ìƒì„± ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                C2C.ui.showToast('ë°© ìƒì„± ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'danger');
                C2C.ui.hideLoading();
            }
        }
        
        // ê¸°ì¡´ ë°© ì°¸ì—¬ (ê²€ì¦ í¬í•¨)
        async function joinExistingRoom(roomId, nickname) {
            try {
                console.log('ğŸšª ê¸°ì¡´ ë°© ì°¸ì—¬ ì‹œë„:', roomId, nickname);
                
                // âœ¨ í•µì‹¬ ìˆ˜ì •: APIë¡œ ë°© ì¡´ì¬ ì—¬ë¶€ì™€ ì°¸ì—¬ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸
                const joinResponse = await C2C.api.request(`/api/rooms/${encodeURIComponent(roomId)}/join`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: nickname,
                        nickname: nickname
                    })
                });
                
                if (joinResponse.success) {
                    console.log('âœ… ë°© ì°¸ì—¬ API ì„±ê³µ:', joinResponse);
                    
                    // API ì„±ê³µ í›„ ì±„íŒ…ë°© í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = `/join/${encodeURIComponent(roomId)}?nickname=${encodeURIComponent(nickname)}`;
                } else {
                    console.error('âŒ ë°© ì°¸ì—¬ API ì‹¤íŒ¨:', joinResponse);
                    C2C.ui.hideLoading();
                    
                    // ì—ëŸ¬ íƒ€ì…ë³„ ì²˜ë¦¬
                    if (joinResponse.errorCode === 'ROOM_NOT_FOUND' || joinResponse.error?.includes('ì°¾ì„ ìˆ˜ ì—†')) {
                        C2C.ui.showToast('ğŸ’” ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°©ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'danger');
                        
                        // 3ì´ˆ í›„ ë©”ì¸í˜ì´ì§€ë¡œ ì´ë™
                        setTimeout(() => {
                            window.location.href = '/?error=ROOM_NOT_FOUND';
                        }, 3000);
                    } else {
                        C2C.ui.showToast(joinResponse.error || 'ë°© ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'danger');
                    }
                }
                
            } catch (error) {
                console.error('ğŸ’¥ ë°© ì°¸ì—¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                C2C.ui.hideLoading();
                
                if (error.message && error.message.includes('404')) {
                    C2C.ui.showToast('ğŸ’” ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°© ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'danger');
                    setTimeout(() => {
                        window.location.href = '/?error=ROOM_NOT_FOUND';
                    }, 3000);
                } else {
                    C2C.ui.showToast('ë°© ì°¸ì—¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'danger');
                }
            }
        }
        
        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            if (pageData.mode === 'direct' && pageData.roomId) {
                // ì§ì ‘ ë°© ë§í¬ë¡œ ì˜¨ ê²½ìš°
                window.location.href = '/';
            } else {
                // ì¼ë°˜ì ì¸ ê²½ìš°
                history.back();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const nicknameInput = document.getElementById('nickname');
            nicknameInput.focus();
            
            // ëœë¤ ë‹‰ë„¤ì„ ì œì•ˆ (ì„ íƒì )
            const suggestions = [
                'ì»¤í”¼ì‚¬ë‘', 'ë°¤ì˜¬ë¹¼ë¯¸', 'ìƒˆì‹¹ì´', 'êµ¬ë¦„íƒ€ê³ ', 'ë³„êµ¬ê²½',
                'ì±…ë²Œë ˆ', 'ìŒì•…ê´‘', 'ì—¬í–‰ëŸ¬', 'ê¿ˆê¾¸ëŠ”ì´', 'ììœ ì¸'
            ];
            
            // í”Œë ˆì´ìŠ¤í™€ë”ì— ëœë¤ ì œì•ˆ í‘œì‹œ
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            nicknameInput.placeholder = `ì˜ˆ: ${randomSuggestion}`;
        });
        
        // ì—”í„°í‚¤ë¡œ í¼ ì œì¶œ
        document.getElementById('nickname').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitForm(e);
            }
        });
    </script>
</body>
</html>