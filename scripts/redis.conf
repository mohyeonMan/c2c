# C2C MVP Redis 설정 파일
# Docker 컨테이너 환경에 최적화

# 기본 설정
bind 0.0.0.0
port 6379
timeout 300
tcp-keepalive 60

# 메모리 관리 (Docker 환경 최적화)
maxmemory 256mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# 영속성 설정 (AOF 사용)
# RDB와 AOF 모두 사용하여 데이터 안전성 확보
save 900 1
save 300 10
save 60 10000

appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# 네트워크 설정
tcp-backlog 511
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Pub/Sub 최적화 (C2C 메시지 브로커용)
# 클라이언트 연결 제한
maxclients 100

# 슬로우 로그 설정
slowlog-log-slower-than 10000
slowlog-max-len 128

# 보안 설정
# requirepass your_redis_password  # 운영환경에서는 비밀번호 설정 필수
protected-mode no  # Docker 네트워크에서는 비활성화

# 로깅
loglevel notice
logfile ""  # Docker에서는 stdout 사용

# 데이터베이스 설정
databases 16

# 키 만료 설정 (C2C 비즈니스 요구사항)
# 프레즌스: 30초 TTL
# 방 멤버: 5분 TTL
# Lazy expiration 활성화
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Hash 최적화 (작은 객체에 대한 메모리 효율성)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Set 최적화 (방 멤버 관리용)
set-max-intset-entries 512

# List 최적화
list-max-ziplist-size -2
list-compress-depth 0

# 스레드 설정 (멀티스레딩 I/O)
io-threads 2
io-threads-do-reads yes

# 모듈 로딩 (필요시)
# loadmodule /path/to/module.so

# 알림 설정 (키 이벤트 알림)
notify-keyspace-events "Ex"  # 만료 이벤트만 활성화

# 클러스터 설정 (단일 인스턴스에서는 비활성화)
# cluster-enabled no

# 백그라운드 저장 시 메모리 사용량 제한
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes

# 디스크 동기화 설정
aof-rewrite-incremental-fsync yes
aof-use-rdb-preamble yes

# 통계 및 모니터링
latency-monitor-threshold 100

# Lua 스크립트 설정 (C2C에서 원자적 처리용)
lua-time-limit 5000

# 메모리 사용량 보고
activerehashing yes

# HyperLogLog 설정
hll-sparse-max-bytes 3000

# 스트림 설정 (향후 Redis Streams 사용 시)
stream-node-max-bytes 4096
stream-node-max-entries 100

# 기본 사용자 (ACL 설정)
user default on nopass ~* &* -@dangerous +@all

# 주석: C2C MVP 특화 설정
# - 프레즌스 관리를 위한 TTL 최적화
# - Pub/Sub 성능을 위한 버퍼 설정
# - Docker 환경에서의 메모리 제한 고려
# - 개발/운영 환경 구분을 위한 설정 분리 가능